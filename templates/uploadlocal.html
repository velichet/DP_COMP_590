<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href={{url_for('static', filename='utils/logo.png')}}>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script defer src="https://pyscript.net/releases/2022.12.1/pyscript.js"></script>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"
    />

    <link href={{url_for('static', filename='style/nav.css')}} rel="stylesheet" />
    <link href={{url_for('static', filename='style/upload.css')}} rel="stylesheet" />

    <title>Safely Stat</title>
  </head>
  <body>
    <div class="container-fluid">
      {% include 'nav.html' %}

      <div class="row">
        <div class="upload-form col-sm-12">
          <h3>Upload Dataset</h3>
          <form id="dataInput" class="border-top">
            <label for="datasetTitle" class="form-label mt-2">Title</label>
            <input
              type="text"
              class="form-control"
              id="datasetTitle"
              placeholder="My dataset"
              name="title"
            />

            <label for="datasetDesc" class="form-label mt-2">Description</label>
            <textarea
              class="form-control desc-box"
              id="datasetDesc"
              rows="4"
              placeholder="This dataset contains..."
              name="description"
            ></textarea>

            <!-- Stats -->
            <div id="stats" class="mt-4 border-top">
                <h5 class="mt-3">Field Statistics</h5>
                <p class="mt-2 mb-2 container-fluid">In the following section, specify the field (column) in 
                    your dataset you wish to include in the gallery piece. We currently only have support
                    for count measurements in the local mode. Please note, when you upload 
                    your CSV dataset, your data will be automatically uploaded and you will be redirected 
                    to your MyData page.
                </p>
                <div class="container-fluid" id="add-col-btn">
                    <div class="row" id="col-stat-box">
                        <div class="col-sm-12">
                            <label for="columnTitle" class="form-label mt-2">Field Name</label>
                            <input
                              type="text"
                              class="form-control"
                              id="columnTitle"
                              placeholder="Field one"
                              name="col_name"
                            />

                        </div>
                    </div>
                </div>
            </div>
            <!-- Stats -->
            <div class="border-top mt-3">
            <h5 class="mt-3">Upload CSV Dataset</h5>
            <label for="formFile" class="form-label">CSV File</label>
            <input class="form-control" type="file" id="csvFile">
          </div>
          </form>
        </div>
      </div>
    </div>

    <py-script>
      import js
      from pyodide.ffi.wrappers import add_event_listener
      import asnycio
      import json
      from request import request

      async def upload_and_run(event):
        baseurl = js.window.location.origin

        title = Element('datasetTitle').value
        desc = Element('datasetDesc').value
        field = Element('columnTitle').value
        dataset = Element('csvFile').value

        # LOCAL DP CODE

        # POST REQUEST
        headers = {"Content-type": "application/json"}
        body = json.dumps({
          "title": title,
          "description": description,
          "local": true
          ... # FINISH THIS
        })
        post = await request(f"{baseurl}/upload", body=body, method="POST", headers = headers)
        print(f"POST request=> status:{new_post.status}, json:{await new_post.json()}")

      csv_input = js.document.getElementById('csvFile')
      add_event_listener(csv_input, "change", upload_and_run())
      asyncio.ensure_future(upload_and_run())
    </py-script>
    
    {% include 'footer.html' %}

    <!-- Scripts -->

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
